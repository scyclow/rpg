<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>test</title>
  <!-- <link rel="shortcut icon" type="image/x-icon" href="./assets/kiss.png" id="favicon"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- <meta name="description" content="ðŸ’‹ Chat with sexy findoms ðŸ¥µ Send until it hurts ðŸ’¸ (18+) ðŸ”ž"> -->
  <!-- <meta name="keywords" content="finsexy, chatbots, ai, stable diffusion, text adventure, rpg, steviep, steve pikelny, pikelny, crypto, ethereum, nft, nfts, blockchain, bitcoin"> -->

  <!-- <meta name="twitter:image" content="https://finsexy.com/assets/thumbnail.png"> -->
  <!-- <meta name="twitter:image:alt" content="WARNING! The SEXY FINDOMS on this website will SUCK your wallet dry. Proceed at your own risk."> -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steviepxyz">
  <meta name="twitter:site" content="@steviepxyz">
  <!-- <meta property="twitter:description" content="ðŸ’‹ Chat with sexy findoms ðŸ¥µ Send until it hurts ðŸ’¸ (18+) ðŸ”ž"> -->

  <!-- <meta name="og:image" property="og:image" content="https://finsexy.com/assets/thumbnail.png"> -->
  <!-- <meta name="og:image:alt" content="WARNING! The SEXY FINDOMS on this website will SUCK your wallet dry. Proceed at your own risk."> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:url" content="https://finsexy.com/"> -->
  <!-- <meta property="og:title" content="FinSexy.com"> -->
  <!-- <meta property="og:site_name" content="FinSexy"> -->
  <!-- <meta property="og:description" content="ðŸ’‹ Chat with sexy findoms ðŸ¥µ Send until it hurts ðŸ’¸ (18+) ðŸ”ž"> -->


  <link rel="stylesheet" type="text/css" href="./styles.css">
</head>
<body>

<script type="module">
  import {ls} from './$.js'

  window.GAME_VERSION = 0.2

  const LAST_PLAYED_GAME_VERSION = ls.get('__GAME_VERSION')
  if (LAST_PLAYED_GAME_VERSION !== GAME_VERSION) {
    localStorage.clear()
  }
  ls.set('__GAME_VERSION', GAME_VERSION)
</script>

  <main id="currentDisplay">
    <section id="mainConsole">
      <header><span id="consoleLocation"></span><time id="consoleTime"></time><span id="consoleTemperature"></span></header>
      <section id="mainConsolePrimary">
        <section id="mainConsoleContent"></section>

        <aside id="nextActions"></aside>
      </section>
    </section>
    <trapped-modal id="phoneModal" blur="true">
      <mobile-phone id="phoneDevice" slot="content"></mobile-phone>
    </trapped-modal>
  </main>

</body>



<script src="./utils.js"></script>
<script type="module" src="./modal.js"></script>
<script type="module" src="./mobilePhone.js"></script>



<script type="module">
  import {$} from './$.js'
  import {StateMachine, CTX} from './stateMachine.js'
  import {persist} from './persist.js'
  import {globalState, setColor} from './global.js'
  import {createSource, MAX_VOLUME} from './audio.js'




  const $phoneModal = $.id('phoneModal')
  const $phoneDevice = $.id('phoneDevice')
  const $consoleLocation = $.id('consoleLocation')
  const $consoleTime = $.id('consoleTime')
  const $consoleTemperature = $.id('consoleTemperature')


  const group = (nodesInput, props) => Object.keys(nodesInput).reduce((nodesOutput, nodeName) => ({
    ...nodesOutput,
    [nodeName]: { ...props, ...nodesInput[nodeName]}
  }), {})

  const options = mapping => ({ur}) => mapping[ur]

  setTimeout(() => {
    $.id('mainConsoleContent').classList.add('smoothScroll')
  }, 200)


  const primaryStartingCtx = persist('__PRIMARY_SM_CTX', new CTX({
    currentNode: 'start',
    fallbackNode: 'bedroom',
    currentActions: [],
    state: {
      // TODO: wifi shouldn't work if unplugged
      router: {
        pluggedIn: true
      },
      stairwayLevel: 0
    }
    // state: {
    //   apartment: {
    //     lastNode: 'bed',

    //     bedActions: [
    //       { text: 'Phone', value: '1'},
    //       { text: 'Alarm Clock', value: '2'},
    //       { text: 'Stand Up', value: '3'},
    //     ],

    //     bedroomActions: [
    //       { text: 'Phone', value: '1'},
    //       { text: 'Alarm Clock', value: '2'},
    //       { text: 'Bed', value: '3'},
    //       { text: 'Blinds', value: '4'},
    //       { text: 'Lamp', value: '5'},
    //       { text: 'Hallway', value: '6'},
    //     ]
    //   },

    //   phone: {

    //   }
    // }
  }))


  /*

    TODO



  */

  const tmp = {}

  window.tmp = tmp



  const niceLocation = {
    bed: 'Bedroom',
    bedroom: 'Bedroom',
    externalHallway: '???',
    stairway: '???',
    hallway: 'Hallway',
    livingRoom: 'Living Room',
    kitchen: 'Kitchen',
    bathroom: 'Bathroom',
    nothing: ''
  }

  const primaryConfig = {
    defaultWait: 300,
    async onUpdate({ text, actions }, sm) {
      sm.ctx.history.push(text)
      globalState.eventLog.push({timestamp: Date.now(), event: { type: 'mainConsole', payload: text}})
      const $content = $.id('mainConsoleContent')

      if (text) {
        const p = $.p(text, {class: 'preVisible'})
        $content.insertBefore(p, $content.firstChild)
        // setTimeout(() => p.classList.remove('preVisible'), 30)
      }

      // $content.innerHTML += `<p>${text}</p>`

      if (!['openPhone', 'closePhone'].includes(sm.ctx.currentNode)) {
        $content.scrollTop = 0
      }


      $consoleLocation.innerHTML = niceLocation[globalState.location]


      if (actions instanceof Function) {
        actions = await sm.evaluate(actions)
      }

      if (actions && !deepEquals(actions.map(a => a.value), sm.ctx.currentActions.map(a => a.value))) {
        const phoneNotifications = $phoneDevice.phoneNotifications()
        $.id('nextActions').innerHTML = actions.map(a => `<button id="${sm.ctx.currentNode}-${a.value}">${
          a.text + (
            a.text === 'Phone' && phoneNotifications
              ? ` (${phoneNotifications})`
              : ''
          )
        }</button>`).join('')

        actions.forEach(a => $.id(`${sm.ctx.currentNode}-${a.value}`).onclick = () => {
          if (a.onClick) a.onClick()
          sm.next(a.value)
        })

        sm.ctx.currentActions = actions
        $phoneDevice.setState({ availableActions: actions.filter(a => a.text !== 'Phone')})
      }
    },
  }

  const primaryNodes = {
    start: {
      handler: 'intro'
    },
    intro: [
      { text: 'You wake up', wait: 1800},
      { text: 'A vague sense of dread lingers from a dream you no longer remember', wait: 1800},
      {
        before() {
          globalState.location = 'bed'
          $consoleLocation.innerHTML = niceLocation[globalState.location]
        },
        text: 'Your first conscious thought is to reach for your phone',
        follow: 'bedFresh'
      },
      // { text: 'Your first conscious inclination is to reach for your phone', follow: 'bedFresh' },
    ],

    ...group({
      bedFresh: {
        text: '',
      },

      bed: {
        before({ ctx }) {
          globalState.location = 'bed'
        },
        text: 'You get into bed'
      },

      bedAlarm: {
        text: 'You look at the alarm clock. It flashes 88:88:88. It does not seem to have any buttons',
        follow({ctx}) {
          ctx.state.checkedAlarmClock = true
          $consoleTime.innerHTML = ' â€” 88:88:88'
        }
      },
    }, {
      actions: [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Alarm Clock', value: 'bedAlarm'},
        { text: 'Stand Up', value: 'standUpBed'},
      ],
      handler: ({ur}) => ur

    }),

    openPhone: {
      before({ ctx, enqueue }) {
        ctx.stack.push(ctx.lastNode)
        $phoneModal.open()
        if (!$phoneDevice.state.started) {
          $phoneDevice.start()
        }
        $phoneModal.onClose(() => {
          enqueue('closePhone')
        })
      },
      text: 'You open your phone',
      wait: 0
    },

    closePhone: {
      text: 'You close your phone',
      follow({ ctx, redirect }) {
        redirect(ctx.stack.pop())
      }
    },

    ...group({
      standUpBed: {
        text: 'You get out of bed',
      },
      bedroom: {
        before({ ctx }) {
          globalState.location = 'bedroom'
        },
        text: 'You enter the bedroom',
      },
      bedroomAlarm: {
        text: 'You look at the alarm clock. It flashes 88:88:88. It does not seem to have any buttons',
        follow({ctx}) {
          ctx.state.checkedAlarmClock = true
          $consoleTime.innerHTML = ' â€” 88:88:88'
        }
      },
      bedroomWindow: {
        text: `Sunlight leaks through the closed blinds. It must be daytime. You don't see a way to open them, but you notice a QR code accompanied with instructions: "Scan this QR code to download the <em>Shayd</em> App!"`
      },
      bedroomLamp: {
        text: `You inspect the lamp. You don't see a light switch, but you do see a QR code pasted to its side with no label`
      }
    }, {
      actions: [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Hallway', value: 'hallway'},
        { text: 'Alarm Clock', value: 'bedroomAlarm'},
        { text: 'Bed', value: 'bed'},
        { text: 'Window', value: 'bedroomWindow', qr: { screen: 'appMarket', appMarketPreSearch: 'shayd'}},
        { text: 'Lamp', value: 'bedroomLamp', qr: { screen: 'messageViewer', messageViewerMessage: 'Illuminate your home with the Lumin app. Available only in AppMarket!'}},
      ],
      handler: ({ur}) => ur
    }),

    ...group({
      hallway: {
        before({ ctx }) {
          globalState.location = 'hallway'
        },
        text: ({ctx}) => `You enter the hallway`,
        follow: async ({ctx}) => {
          await waitPromise(1500)
          if (!ctx.state.hallwayVisited) {
            return 'motionSensor'
          }
        },
        after({ ctx }) {
          ctx.state.hallwayVisited = true
        }
      },

      motionSensor: {
        text: 'A motion sensor picks up your movement and the camera above the front door comes to life',
        follow: async () => {
          await waitPromise(3000)
          return 'weirdHum'
        }
      },

      weirdHum: {
        text: `You hear a noise, but can't place its location`
      },

      hallwayCurrent: {
        text: ''
      },

      camera: {
        text: `The small camera looks down at you. Whenever you move it moves along with you. You make out some tiny print on its side: "SmartPro Security Camera: Keeping you safe since 2010. Download our App in the AppMarket!"`
      },


      thermostat: {
        text: `You check the thermostat. Every light is on, and it reads: 88Ëš. You're not sure if it's accurate, but for the first time you realize how uncomfortably warm it is`,
        follow({ctx}) {
          ctx.state.checkedThermostat = true
          $consoleTemperature.innerHTML = ' â€” 88Ëš'
        }
      },

      intercom: {
        text: `You look at the intercom. It hasn't worked in years. "Talk" and "Door" do nothing. "Listen" only produces static`
      },

    }, {
      actions: ({ctx}) =>  [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Living Room', value: 'livingRoom'},
        { text: 'Bathroom', value: 'bathroom'},
        { text: 'Bedroom', value: 'bedroom'},
        { text: 'Front Door', value: 'frontDoor',  qr: {screen: 'messageViewer', messageViewerMessage: 'Powered by SmartLock Technology<sup>TM</sup> Download the Official App today!'} },
        { text: 'Camera', value: 'camera'},
        { text: 'Thermostat', value: 'thermostat'},
        { text: 'Intercom', value: 'intercom'},
      ],
      handler: ({ur}) => ur
    }),

    smartLockShift: {
      text: 'You hear a motor turn, followd by a click',
      after({ ctx, redirect }) {
        redirect(ctx.lastNode)
      },
    },


    ...group({
      frontDoor: {
        text: ({ctx}) => `The front door is closed. Above the doorknob is a QR code${ctx.state.envelopesPickedUp ? '': '. You notice three envelopes at your feet'}`,
      },

      pickupEnvelopes: {
        before({ctx}) {
          ctx.state.envelopesPickedUp = true
        },
        text: `You pick up all three envelopes. The first is from your landlord, Landlock Realty LLC. You owe them $6,437.98. The second is from HealthyLiving Inc. You owe them $14,038.71. You can pay this online. At the bottom of the letter it says: "Your health is priceless!" The third is junk mail. It says:
        <div>
          <div style="border: 1px solid; padding: 0.5em; display: inline-block; margin: 0.5em;">
            <p class="letterText">Dear NEIGHBOR,</p>
            <p class="letterText">Special Promotion for LIMITED TIME only FREE TRIAL for MOBILE + DATA Plan</p>
            <p class="letterText">Service Provider Code (SPC): 00010-032991</p>
            <p class="letterText">District Index: B47</p>
            <p class="letterText">Unlock Code: Qz8!9g97tR$f29</p>
            <p class="letterText">ZC: 00000</p>

          </div>
        </div>

        `
      },

      openDoorLocked: {
        text: `You try turning the doorknob. It appears to be locked`
      },

      closeDoor: {
        before() {
          if (globalState.lightsOn) {
            setColor('--bg-color', '#fff')
            setColor('--primary-color', '#000')
          } else {
            setColor('--bg-color', 'var(--dark-color)')
            setColor('--primary-color', 'var(--light-color)')
          }
        },
        text: `You close the door.`
      },

      reenterApartment: {
        before({ ctx }) {
          globalState.location = 'hallway'
          if (globalState.lightsOn) {
            setColor('--bg-color', '#fff')
            setColor('--primary-color', '#000')
          } else {
            setColor('--bg-color', 'var(--dark-color)')
            setColor('--primary-color', 'var(--light-color)')
          }
        },
        text: `You reenter your apartment and close the door.`
      },

      frontDoorListen: {
        before() {
          try {
            tmp.src1 = createSource('sine')
            tmp.src2 = createSource('sine')

            tmp.src1.smoothFreq(100)
            tmp.src2.smoothFreq(100.1)

            tmp.src1.smoothGain(MAX_VOLUME/2, 2)
            tmp.src2.smoothGain(MAX_VOLUME/2, 2)
          } catch (e) {
            console.log(e)
          }
        },
        text: `You put your ear to the door. All you hear is a low hum`,
      }

    }, {
      handler: ({ur}) => ur,
      actions: ({ctx}) => [
        {text: 'Back', value: 'hallwayCurrent'},
        {text: 'Open Door', value: globalState.smartLockOpen ? 'openDoorUnlocked' : 'openDoorLocked'},
        {text: 'Listen Closely', value: 'frontDoorListen'},
        ctx.state.envelopesPickedUp ? null : {text: 'Pick Up Envelopes', value: 'pickupEnvelopes'}
      ].filter(exists),
      after() {
        if (tmp.src1 && tmp.src2) {
          tmp.src1.smoothGain(0.000001, 1)
          tmp.src2.smoothGain(0.000001, 1)

          setTimeout(() => {
            tmp.src1.stop()
            tmp.src2.stop()
          }, 10000)
        }
      }
    }),

    ...group({
      livingRoom: {
        text: `You enter the living room`,
        async follow({ ctx }) {
          await waitPromise(1500)
          if (!ctx.state.livingRoomVisited) {
            ctx.state.livingRoomVisited = true
            globalState.location = 'livingRoom'
            return 'wonderPlants'
          } else if (globalState.location === 'kitchen' && !ctx.state.envelopesPickedUp) {
            globalState.location = 'livingRoom'
            return 'hearSomething'
          }
        },
      },

      wonderPlants: {
        text: 'You wonder how your plants are doing'
      },

      hearSomething: {
        text: 'You hear a something in the hallway'
      },

      livingRoomCurrent: {
        text: ''
      },

      // TODO update if dead

      planter: {
        text: `You check your plants. The leaves sag from a lack of light${globalState.plantWatered ? '' : ' and water'}. On the side of the pot you read: "SmartPlanter<sup>TM</sup> - The quick and easy way to conveniently water your plants! Download our app in the AppMarket. DEVICE CODE: F93892O30249B48"`
      },

      livingRoomWindow: {
        text: `Sunlight leaks through the closed blinds. It must be daytime. You don't see a way to open them, but you notice a QR code accompanied with instructions: "Scan this QR code to download the <em>Shayd</em> App!"`
      },

      ebook: {
        text: 'You pick up the ebook. You read: "Cannot access Library"'
      },
      tv: {
        text: 'The black screen of the TV looms ominously over you.'
      }
    }, {
      actions: [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Hallway', value: 'hallway'},
        { text: 'Kitchen', value: 'kitchen'},
        { text: 'SmartPlanter', value: 'planter'},
        { text: 'Window', value: 'livingRoomWindow', qr: { screen: 'appMarket', appMarketPreSearch: 'shayd'}},
        { text: 'Router', value: 'router'},
        { text: 'TV', value: 'tv'},
        { text: 'ebook', value: 'ebook'},
      ],
      handler: ({ur}) => ur

    }),

    ...group({
      router: {
        text: ({ctx}) => ctx.state.router.pluggedIn
          ? `You inspect the router, which appears to have a reset button and three lights:
          <div>Power (on)</div>
          <div>Internet (${globalState.wifiActive ? 'on' : 'off'})</div>
          <div>WiFi (${globalState.routerReset ? 'on' : 'blinking'})</div>
          `
          : `You inspect the router. The Power, Internet, and WiFi lights are all off`
      },

      resetRouter: {
        text: `You push the router's reset button. Nothing happens`
      },

      bottomRouter: {
        text: `You pick up the router and look at the bottom. A sticker says:
        <div>
          <div style="border: 1px solid; padding: 0.5em; display: inline-block; margin: 0.5em; border-radius: 8px">
            <h3>WiFi Network Name: InpatientRehabilitationServices</h3>
            <h3>WiFi Password: StompLookAndListen123</h3>
            <h3>Model Name: UBC-9283</h3>
            <h3>Device Identifier: 5879234963378</h3>
            <h3>Customer Support: 1-800-555-2093</h3>
          </div>
        </div>
        `
      }
    }, {
      actions: ({ctx}) => [
        { text: 'Back', value: 'livingRoomCurrent'},
        { text: 'Push Reset Button', value: 'resetRouter'},
        { text: 'Look At Bottom of Router', value: 'bottomRouter'},
        { text: 'Check Power', value: 'checkWifiPower'},
      ],
      handler: ({ur}) => ur
    }),

    ...group({
      checkWifiPower: {
        text: ({ctx}) => `You follow the router's power chord to a socket in the wall. It is ${ctx.state.router.pluggedIn ? 'plugged in' : 'unplugged'}`
      },
      unplugRouter: {
        text: `You unplug the router. The Power, Internet, and WiFi lights immediately turn off`,
        wait: 0
      },

      plugInRouter: {
        text: ({ctx}) => `You plug the router back in. The Power, Internet, and WiFi lights all turn off for one second, turn back on for one second, and blink for three seconds${globalState.routerReset ? ' before returning to their original states.' : '. The WiFi light is now on.'}`,
        wait: 0,
        follow() {
          globalState.routerReset = true
        }
      },

    }, {
      handler: ({ur}) => ur,
      actions({ctx}) {
        return [
          { text: 'Back', value: 'router'},
          ctx.state.router.pluggedIn
            ? { text: 'Unplug Router', value: 'unplugRouter', onClick: () => ctx.state.router.pluggedIn = false}
            : { text: 'Plug In Router', value: 'plugInRouter', onClick: () => ctx.state.router.pluggedIn = true},
        ]
      }
    }),


    ...group({
      bathroom: {
        before({ ctx }) {
          globalState.location = 'bathroom'
        },
        text: ({ctx}) => `You enter the bathroom${ctx.state.usedToilet ? '. You pick up the faint smell of stale urine' : ''}`,
        after({ ctx }) {
          ctx.state.bathroomVisited = true
        }
      },

      bathroomCurrent: {
        text: ''
      },

      toilet: {
        // allow player to use toilet, but need an app to flush. if you use without flushing, it starts to smell
        text: ({ctx}) => ctx.state.usedToilet
          ? `You wave your hand in front of the toilet, but the auto-flusher does not activate`
          : `You use the toilet, but the auto-flusher does not activate`,
        after({ctx}) {
          ctx.state.usedToilet = true
        }
      },
      bathroomSink: {
        text: 'You wave your hands in front of the sink, but nothing happens. A small red light blinks at its base'
      },
      shower: {
        text: 'You look inside the shower. A showerhead sticks out of the wall with a QR code printed on its side'
      },
    }, {
      actions: [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Hallway', value: 'hallway'},
        { text: 'Toilet', value: 'toilet'},
        { text: 'Sink', value: 'bathroomSink'},
        { text: 'Shower', value: 'shower', qr: {screen: 'messageViewer', messageViewerMessage: 'Bathe in luxury'}},
      ],
      handler: ({ur}) => ur
    }),


    ...group({
      kitchen: {
        before({ ctx }) {
          globalState.location = 'kitchen'
        },
        text: ({ctx}) => `You enter the kitchen`,
        after({ ctx }) {
          ctx.state.kitchenVisited = true
        }
      },

      kitchenCurrent: {
        text: ''
      },

      kitchenWindow: {
        text: `Sunlight leaks through the closed blinds. It must be daytime. You don't see a way to open them, but you notice a QR code accompanied with instructions: "Scan this QR code to download the <em>Shayd</em> App!"`
      },
      refrigeratorLocked: {
        text: `You try the door to the refrigerator, but it won't open. A small LED screen on its front says: "LOCKED ||| LOCAL NETWORK INVALID"`
      },

      refrigeratorOpen: {
        text: `You open the refrigerator. It's empty. The air is only slightly cooler than room temperature`
      },
      kitchenSink: {
        text: 'You wave your hands in front of the sink, but nothing happens. A small red light blinks on its side.'
      },
      // oven: {
      //   text: 'todo'
      // },
      toaster: {
        text: () => `You're not quite sure how the toaster works, but you see a QR code on one side. On the other side is an LED screen:
          <div style="margin-top: 0.5em">
            <div style="display: inline-block;border: 1px dashed; padding: 0.5em; background: #79ffec; text-align: center; color: #4b0d5d">
              <h3 style="color: #4b0d5d">User: ToastBaby69</h3>
              <h3 style="color: #4b0d5d">Last toast: ${globalState.wifiActive ?  '52' : 'NaN'} days ago</h3>
              <h3 style="color: #4b0d5d">Total toasts: ${globalState.wifiActive ?  '11' : 'ERROR: Cannot connect to server.'}</h3>
            </div>
          </div>
        `
      },
    }, {
      actions: () => [
        { text: 'Phone', value: 'openPhone'},
        { text: 'Living Room', value: 'livingRoom'},
        { text: 'Window', value: 'kitchenWindow', qr: { screen: 'appMarket', appMarketPreSearch: 'shayd'}},
        { text: 'Refrigerator', value: globalState.wifiActive ? 'refrigeratorOpen' : 'refrigeratorLocked'},
        { text: 'Kitchen Sink', value: 'kitchenSink'},
        // { text: 'Oven', value: 'oven'},
        { text: 'Toaster', value: 'toaster', qr: { screen: 'messageViewer', messageViewerMessage: 'Introducing <em>Toastr</em>: the social way to toast! Download our App today!'}},
      ],
      handler: ({ur}) => ur
    }),


    openDoorUnlocked: {
      before() {
        setColor('--bg-color', '#000')
        setColor('--primary-color', '#fff')
      },
      text: `You turn the doorknob and slowly pull the door open. You stare into darkness`,
        before() {
          try {
            tmp.src1 = createSource('sine')
            tmp.src2 = createSource('sine')

            tmp.src1.smoothFreq(100)
            tmp.src2.smoothFreq(100.1)

            tmp.src1.smoothGain(MAX_VOLUME, 2)
            tmp.src2.smoothGain(MAX_VOLUME, 2)
          } catch (e) {
            console.log(e)
          }
        },
      handler: ({ur}) => ur,
      actions: ({ctx}) => [
        {text: 'Leave apartment', value: 'externalHallway'},
        {text: 'Close Door', value: 'closeDoor'},
      ]
    },

    ...group({
      externalHallway: {
        before({ ctx }) {
          globalState.location = 'externalHallway'

          setTimeout(() => {
            setColor('--bg-color', '#fff')
            setColor('--primary-color', '#000')

            // TODO rumbling noise, shuts off when you enter apartment
          }, 2000)
        },
        text: 'You exit your apartment and enter a hallway. A series of LED lights flicker on and glare overhead. Pipes jut out from the ceiling and recede into the narrow, white walls'
      },

      externalHallwayBack: {
        text: 'You walk back towards the apartment door'
      },
    }, {
      handler: ({ur}) => ur,
      actions: [
        { text: 'Reenter Apartment', value: 'reenterApartment'},
        { text: 'Elevator', value: 'elevator'},
        { text: 'Stairway', value: 'stairway'},
        { text: 'Phone', value: 'openPhone'},
      ]
    }),

    ...group({
      elevator: {
        text: `You approach the elevator, noticing two buttons`,
      },
      elevatorButtons: {
        text: `You try pressing both metalic buttons, but nothing seems to happen`
        // TODO: app
      },

    }, {
      handler: ({ur}) => ur,
      actions: [
        { text: 'Back', value: 'externalHallwayBack'},
        { text: 'Buttons', value: 'elevatorButtons', },
        { text: 'Phone', value: 'openPhone'},
      ]
    }),

    // TODO break up into two actions
    stairway: {
      text: `You approach the stairway door. Standing in front of it, you read a sticker at eye level: "<strong style="font-size: 1.2em; text-decoration: underline">NO RE-ENTRY</strong>"`,
      handler: ({ur}) => ur,
      actions: [
        { text: 'Back', value: 'externalHallwayBack'},
        { text: 'Enter Stairway', value: 'enterStairway'},
        { text: 'Phone', value: 'openPhone'},
      ]
    },

    ...group({
      enterStairway: {
        before({ ctx }) {
          globalState.location = 'stairway'
          setColor('--bg-color', '#000')
          setColor('--primary-color', '#fff')

          if (tmp.src1 && tmp.src2) {
            tmp.src1.smoothGain(0.000001, 1)
            tmp.src2.smoothGain(0.000001, 1)

            setTimeout(() => {
              tmp.src1.stop()
              tmp.src2.stop()
            }, 10000)
          }

        },
        text: `You enter the stairway and hear the door slam shut behind you`,
        async follow() {
          await waitPromise(2000)
          return 'enterStairway1'
        }
      },
      enterStairway1: {
        text: `The sound echos off the cement walls, spiraling around the staircase in both directions`,
        async follow() {
          await waitPromise(2000)
          return 'enterStairway2'
        }
      },
      enterStairway2: {
        text: `You turn around and see a QR code on the door behind you`
      },
      insideStairwayDoorPrimary: {
        text: `You try opening the door, but it's locked`
      },

      stairsUp: {
        before({ctx}) {
          ctx.state.stairwayLevel += 1
        },
        text: `You walk up a flight of stairs`
      },

      stairsDown: {
        before({ctx}) {
          ctx.state.stairwayLevel -= 1
        },
        text: `You walk down a flight of stairs`
      },

    }, {
      handler: ({ur}) => ur,
      actions: ({ctx}) => {
        return [
        {
          text: 'Door',
          value: 'insideStairwayDoorPrimary',
          // qr: ctx.state.stairwayLevel === 0
          qr: {
            screen: 'messageViewer',
            messageViewerMessage: `
              <div style="display: flex; flex-direction: column; justify-content: center; height: 370px">
                <h1 style="text-align: center; margin-bottom: 0.4em"><a href="https://steviep.xyz" target="_blank">steviep.xyz</a></h1>
                <h2 style="text-align: center">2024</h2>
                <button onclick="localStorage.clear(); location.reload()" style="align-self:center; margin-top: 1.4em">Play Again?</button>
              </div>
            `
          }
        },
        { text: 'Stairs (up)', value: 'stairsUp', },
        { text: 'Stairs (down)', value: 'stairsDown', },
        { text: 'Phone', value: 'openPhone'},
      ]}
    }),

  }

  window.primarySM = new StateMachine(primaryStartingCtx, primaryConfig, primaryNodes)


  function rehydrate(ctx, sm) {
    const $content = $.id('mainConsoleContent')
    const $nextActions = $.id('nextActions')

    if (globalState.location === 'externalHallway') {
      setColor('--bg-color', '#fff')
      setColor('--primary-color', '#000')

    } else if (globalState.location === 'stairway') {
      setColor('--bg-color', '#000')
      setColor('--primary-color', '#fff')
    } else if (globalState.lightsOn) {
      setColor('--bg-color', '#fff')
      setColor('--primary-color', '#000')
    } else {
      setColor('--bg-color', 'var(--dark-color)')
      setColor('--primary-color', 'var(--light-color)')
    }


    $consoleLocation.innerHTML = niceLocation[globalState.location]

    if (ctx.state.checkedAlarmClock) {
      $consoleTime.innerHTML = ' â€” 88:88:88'
    }
    if (ctx.state.checkedThermostat) {
      $consoleTemperature.innerHTML = ' â€” 88Ëš'
    }


    if (ctx.currentNode === 'openPhone') {
      sm.goto('closePhone')
    }

    $content.innerHTML = ctx.history.filter(t => t).map(t => `<p>${t}</p>`).reverse().join('')

    const actions = ctx.currentActions || []

    const phoneNotifications = $phoneDevice.phoneNotifications()
    $nextActions.innerHTML = actions.map(a => `<button id="${sm.ctx.currentNode}-${a.value}">${
      a.text + (
        a.text === 'Phone' && phoneNotifications
          ? ` (${phoneNotifications})`
          : ''
      )
    }</button>`).join('')
    actions.forEach(a => $.id(`${ctx.currentNode}-${a.value}`).onclick = () => {
      if (a.onClick) a.onClick()
      sm.next(a.value)
    })
  }

  rehydrate(primaryStartingCtx, primarySM)



  // const phoneStartingCtx = new CTX()
  // const phoneConfig = {
  //   defaultWait: 1500,
  //   async onUpdate({ text, actions }) {
  //     phoneStartingCtx.history.push(text)
  //     $.id('mainConsoleContent').innerHTML += `<p>${text}</p>`
  //     if (actions) {
  //       phoneStartingCtx.state.currentActions = actions
  //     }

  //     $.id('nextActions').innerHTML = JSON.stringify(primaryStartingCtx.state.currentActions)
  //   },
  //   start: 'start'
  // }

  // window.phoneSM = new StateMachine(phoneStartingCtx, phoneConfig, phoneNodes)






  if (!primarySM.ctx.history.length) {
    primarySM.next('')
  }

</script>
</html>